<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup>
    <PerfSetupTool Condition="!Exists('$(PerfSetupTool)')">$(MSBuildThisFileDirectory)\PerfSetup.exe</PerfSetupTool>
    <PerfSetupTypeName>ModuleInitializer</PerfSetupTypeName>
    <PerfSetupMethodName>Initialize</PerfSetupMethodName>
    <InjectModuleSnk />
  </PropertyGroup>

  <!-- Check for the signed assemblies and located strong name key pair file -->
  <PropertyGroup Condition="'$(SignAssembly)'=='true' AND
                 Exists('$(MSBuildProjectDirectory)\$(AssemblyOriginatorKeyFile)')">
    <InjectModuleSnk>$(MSBuildProjectDirectory)\$(AssemblyOriginatorKeyFile)</InjectModuleSnk>
  </PropertyGroup>

  <UsingTask TaskName="PerfSetup"
             AssemblyFile="$(PerfSetupTool)" />

  <Target Name="CheckPrerequisites">
    <!-- Raise an error if we're unable to locate WebApplications.Utilities.Initializer.dll  -->
    <Error Condition="!Exists('$(PerfSetupTool)')" Text="Unable to locate '$(PerfSetupTool)'" />
  </Target>

  <Target Name="PerfSetupTarget"
           Condition="'$(BuildingProject)'=='true' AND
                 Exists('$(PerfSetupTool)')"
      DependsOnTargets="ResolveKeySource">
    <PerfSetup
       AssemblyFile="$(TargetPath)"
       TypeName="$(PerfSetupTypeName)"
       MethodName="$(PerfSetupMethodName)"
       StrongNameKeyPair="$(InjectModuleSnk)"/>
  </Target>

  <!-- Introduces PerfSetup in the chain of compilation targets -->
  <PropertyGroup>
    <CoreBuildDependsOn>
      $(CoreBuildDependsOn);
      PerfSetupTarget
    </CoreBuildDependsOn>
  </PropertyGroup>
</Project>